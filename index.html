<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>地雷探し</title>
  <style>
    :root {
      --bg: #0f172a;          /* slate-900 */
      --panel: #111827;       /* gray-900 */
      --text: #e5e7eb;        /* gray-200 */
      --muted: #9ca3af;       /* gray-400 */
      --accent: #22c55e;      /* green-500 */
      --danger: #ef4444;      /* red-500 */
      --tile: #1f2937;        /* gray-800 */
      --tile-open: #111827;   /* gray-900 */
      --tile-border: #0b1220; /* dark */
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: radial-gradient(1200px 700px at 80% -10%, #1e293b 0%, var(--bg) 55%) fixed;
      color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      padding: 24px;
    }
    .app {
      margin: 0 auto; /* 横方向中央寄せ */
      width: min(100%, 1100px);
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 20px;
    }
    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; }
    }
    .panel {
      background: linear-gradient(180deg, #0b1220, #0a0f1a);
      border: 1px solid #0a1324;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .title { font-size: 20px; font-weight: 700; margin: 0 0 14px; letter-spacing: .4px; }
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .controls label { font-size: 12px; color: var(--muted); }
    .row { display: grid; gap: 8px; align-items: end; grid-template-columns: repeat(3, 1fr); }
    .row > div { display:flex; flex-direction:column; gap:6px; }
    input[type="number"], select, button {
      width: 100%; appearance: none; color: var(--text);
      background: #0b1220; border: 1px solid #14203a; border-radius: 12px; padding: 10px 12px; font-size: 14px;
    }
    button { cursor: pointer; font-weight: 700; letter-spacing: .3px; }
    .btn-primary { background: linear-gradient(180deg, #1b3a2a, #10251a); border-color: #1f8a4c; }
    .btn-danger { background: linear-gradient(180deg, #3a1b1b, #251010); border-color: #8a1f1f; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; }
    .stat { background: #0b1220; border: 1px solid #14203a; border-radius: 12px; padding: 10px; text-align: center; }
    .stat small { color: var(--muted); display:block; font-size: 11px; }
    .stat strong { font-size: 18px; }

    .board-wrap { display: grid; gap: 12px; }
    .board-head { display: flex; gap: 8px; align-items: center; justify-content: space-between; }
    .legend { font-size: 12px; color: var(--muted); }

    .board { 
      display: grid; 
      background: #0b1220; border: 1px solid #14203a; border-radius: var(--radius); padding: 10px; box-shadow: var(--shadow);
      touch-action: manipulation; user-select: none;
    }
    .cell { 
      width: var(--cell-size);
      height: var(--cell-size);
      display: grid;
      place-items: center; 
      background: var(--tile); 
      border: 1px solid var(--tile-border); 
      border-radius: 8px; 
      font-weight: 800; 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial;
      transition: transform .05s ease;
    }
    .cell:active { transform: translateY(1px); }
    .cell.open { background: var(--tile-open); border-color: #0f1a30; }
    .cell.flag::after { content: "🚩"; }
    .cell.mine.revealed { background: #2a0e12; }

    /* 数字色 */
    .n1 { color: #60a5fa; } /* blue-400 */
    .n2 { color: #34d399; }
    .n3 { color: #fb7185; }
    .n4 { color: #a78bfa; }
    .n5 { color: #f59e0b; }
    .n6 { color: #22d3ee; }
    .n7 { color: #e5e7eb; }
    .n8 { color: #9ca3af; }

    .pill { padding: 6px 10px; border-radius: 999px; font-size: 12px; background: #0b1220; border: 1px solid #14203a; }
    .spaced { display:flex; align-items:center; gap:10px; }
    .hint { font-size: 12px; color: var(--muted); }
    .footer { margin-top: 8px; font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="app">
    <section class="panel">
      <h1 class="title">地雷探し</h1>
      <div class="controls" style="grid-template-columns:1fr; gap:14px;">
        <div>
          <label>難易度</label>
          <select id="difficulty">
            <option value="easy">初級（9×9 / 地雷10）</option>
            <option value="medium">中級（16×16 / 地雷40）</option>
            <option value="hard">上級（30×16 / 地雷99）</option>
            <option value="custom">カスタム</option>
          </select>
        </div>
        <div class="row" id="customRow" style="display:none;">
          <div>
            <label>横幅（列）</label>
            <input id="cols" type="number" min="5" max="40" value="10" />
          </div>
          <div>
            <label>高さ（行）</label>
            <input id="rows" type="number" min="5" max="30" value="10" />
          </div>
          <div>
            <label>地雷数</label>
            <input id="mines" type="number" min="1" max="300" value="10" />
          </div>
        </div>
        <div class="spaced">
          <button id="newGame" class="btn-primary">新しいゲーム</button>
          <button id="revealAll" class="btn-danger" title="チート：全表示">全表示</button>
        </div>
      </div>

      <div class="stats">
        <div class="stat"><small>地雷残り</small><strong id="mineCount">0</strong></div>
        <div class="stat"><small>タイム</small><strong id="timer">0.0s</strong></div>
        <div class="stat"><small>状態</small><strong id="status">準備OK</strong></div>
      </div>

      <div class="footer">
        左クリック／タップ：開く　｜　右クリック／長押し：旗　｜　数字をクリック：周囲オープン（旗数一致時）
      </div>
    </section>

    <section class="board-wrap">
      <div class="board-head">
        <div class="legend">
          <span class="pill">安全第一・オリジナルUI（Microsoftの資産は未使用）</span>
        </div>
        <div class="hint" id="sizeLabel"></div>
      </div>
      <div id="board" class="board"></div>
    </section>
  </div>

  <script>
    // --- ゲーム状態 ---
    const boardEl = document.getElementById('board');
    const mineCountEl = document.getElementById('mineCount');
    const timerEl = document.getElementById('timer');
    const statusEl = document.getElementById('status');
    const sizeLabelEl = document.getElementById('sizeLabel');
    const difficultyEl = document.getElementById('difficulty');
    const customRowEl = document.getElementById('customRow');

    let ROWS = 9, COLS = 9, MINES = 10;
    let grid = []; // 各セル: {r,c,mine,open,flag,count,el}
    let started = false, finished = false;
    let startTime = 0, timerId = null, flags = 0, opened = 0;

    function setDifficulty(preset) {
      if (preset === 'easy') { ROWS=9; COLS=9; MINES=10; }
      else if (preset === 'medium') { ROWS=16; COLS=16; MINES=40; }
      else if (preset === 'hard') { ROWS=16; COLS=30; MINES=99; }

      // 盤面が大きい場合はセルを小さくする
      let size = 32;
      if (COLS > 20) size = 24;
      if (COLS > 28) size = 20;
      document.documentElement.style.setProperty('--cell-size', size + 'px');

      sizeLabelEl.textContent = `${COLS}×${ROWS}（地雷 ${MINES}）`;
      boardEl.style.gridTemplateColumns = `repeat(${COLS}, var(--cell-size))`;
      boardEl.style.gridAutoRows = `var(--cell-size)`;
    }  

    difficultyEl.addEventListener('change', (e) => {
      const v = e.target.value;
      customRowEl.style.display = v === 'custom' ? 'grid' : 'none';
      if (v !== 'custom') { setDifficulty(v); newGame(); }
    });

    document.getElementById('cols').addEventListener('change', syncCustom);
    document.getElementById('rows').addEventListener('change', syncCustom);
    document.getElementById('mines').addEventListener('change', syncCustom);

    function syncCustom(){
      const cols = clamp(parseInt(document.getElementById('cols').value||10),5,40);
      const rows = clamp(parseInt(document.getElementById('rows').value||10),5,30);
      const maxMines = Math.max(1, rows*cols - 1);
      const mines = clamp(parseInt(document.getElementById('mines').value||10),1,Math.min(300,maxMines));
      COLS=cols; ROWS=rows; MINES=mines;

      // サイズを自動調整
      let size = 32;
      if (COLS > 20) size = 24;
      if (COLS > 28) size = 20;
      document.documentElement.style.setProperty('--cell-size', size + 'px');

      sizeLabelEl.textContent = `${COLS}×${ROWS}（地雷 ${MINES}）`;
      boardEl.style.gridTemplateColumns = `repeat(${COLS}, var(--cell-size))`;
      boardEl.style.gridAutoRows = `var(--cell-size)`;
      newGame();
    }

    document.getElementById('newGame').addEventListener('click', newGame);
    document.getElementById('revealAll').addEventListener('click', () => revealAll(true));

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function inBounds(r,c){ return r>=0 && r<ROWS && c>=0 && c<COLS; }

    function neighbors(r,c){
      const res=[];
      for(let dr=-1; dr<=1; dr++){
        for(let dc=-1; dc<=1; dc++){
          if(dr===0 && dc===0) continue;
          const nr=r+dr, nc=c+dc;
          if(inBounds(nr,nc)) res.push(grid[nr][nc]);
        }
      }
      return res;
    }

    function layMines(exceptR, exceptC){
      let cells=[];
      for(let r=0;r<ROWS;r++){
        for(let c=0;c<COLS;c++){
          // 最初に開いたセルとその周囲には地雷を置かない
          const dist = Math.max(Math.abs(r-exceptR), Math.abs(c-exceptC));
          if(dist<=1) continue;
          cells.push({r,c});
        }
      }
      shuffle(cells);
      for(let i=0;i<MINES && i<cells.length;i++){
        const {r,c} = cells[i];
        grid[r][c].mine = true;
      }
      // 数字を計算
      for(let r=0;r<ROWS;r++){
        for(let c=0;c<COLS;c++){
          grid[r][c].count = neighbors(r,c).filter(n=>n.mine).length;
        }
      }
    }

    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

    function buildBoard(){
      grid = Array.from({length: ROWS}, (_,r)=>Array.from({length: COLS}, (_,c)=>({
        r,c, mine:false, open:false, flag:false, count:0, el:null
      })));
      boardEl.innerHTML = '';
      boardEl.style.gridTemplateColumns = `repeat(${COLS}, 32px)`;
      boardEl.style.gridAutoRows = `32px`;
      for(let r=0;r<ROWS;r++){
        for(let c=0;c<COLS;c++){
          const div=document.createElement('div');
          div.className='cell';
          div.dataset.r=r; div.dataset.c=c;
          attachCellEvents(div);
          boardEl.appendChild(div);
          grid[r][c].el=div;
        }
      }
    }

    function startTimer(){
      startTime = performance.now();
      timerId = setInterval(()=>{
        const s = (performance.now()-startTime)/1000;
        timerEl.textContent = s.toFixed(1)+"s";
      }, 100);
    }
    function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }

    function newGame(){
      finished=false; started=false; flags=0; opened=0; stopTimer(); timerEl.textContent='0.0s';
      statusEl.textContent='準備OK';
      mineCountEl.textContent = MINES;
      buildBoard();
    }

    function openCell(cell){
      if(finished || cell.open || cell.flag) return;
      if(!started){ // 初手で地雷を避けて配置
        layMines(cell.r, cell.c);
        started=true; startTimer(); statusEl.textContent='プレイ中';
      }
      cell.open=true; opened++;
      cell.el.classList.add('open');

      if(cell.mine){
        cell.el.classList.add('mine','revealed');
        cell.el.textContent = '💥';
        gameOver(false);
        return;
      }

      if(cell.count>0){
        cell.el.classList.add('n'+cell.count);
        cell.el.textContent = cell.count;
      } else {
        // 空白：周囲を自動的に開く（Flood fill）
        cell.el.textContent = '';
        for(const n of neighbors(cell.r, cell.c)){
          if(!n.open && !n.flag) openCell(n);
        }
      }

      checkWin();
    }

    function toggleFlag(cell){
      if(finished || cell.open) return;
      cell.flag = !cell.flag;
      cell.el.classList.toggle('flag', cell.flag);
      flags += cell.flag ? 1 : -1;
      mineCountEl.textContent = Math.max(0, MINES - flags);
    }

    function chord(cell){
      // 周囲の旗数が数字と一致していれば、未オープンを開く
      if(!cell.open || cell.count===0) return;
      const ns = neighbors(cell.r, cell.c);
      const flagCount = ns.filter(n=>n.flag).length;
      if(flagCount === cell.count){
        for(const n of ns){ if(!n.open && !n.flag) openCell(n); }
      }
    }

    function revealAll(cheat=false){
      finished=true; stopTimer();
      for(let r=0;r<ROWS;r++){
        for(let c=0;c<COLS;c++){
          const cell = grid[r][c];
          if(cell.mine){ cell.el.classList.add('mine','revealed'); cell.el.textContent='💣'; }
          else if(cell.count>0){ cell.el.classList.add('open','n'+cell.count); cell.el.textContent=cell.count; }
          else { cell.el.classList.add('open'); cell.el.textContent=''; }
        }
      }
      statusEl.textContent = cheat ? '全表示（確認用）' : '終了';
    }

    function gameOver(win){
      finished=true; stopTimer();
      if(!win){
        // すべての地雷を見せる
        for(let r=0;r<ROWS;r++){
          for(let c=0;c<COLS;c++){
            const cell = grid[r][c];
            if(cell.mine && !cell.el.classList.contains('revealed')){
              cell.el.classList.add('mine','revealed');
              if(!cell.flag) cell.el.textContent='💣';
            }
          }
        }
      }
      statusEl.textContent = win ? 'クリア！' : 'ゲームオーバー';
    }

    function checkWin(){
      // 地雷以外の全セルを開いたら勝ち
      const target = ROWS*COLS - MINES;
      if(opened >= target){ gameOver(true); }
    }

    // --- 入力（クリック／右クリック／長押し） ---
    function attachCellEvents(el){
      el.addEventListener('click', onClick);
      el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); const cell=cellFromEl(e.currentTarget); toggleFlag(cell); });
      // 長押しで旗（モバイル）
      let pressTimer=null; let moved=false;
      el.addEventListener('touchstart', (e)=>{
        moved=false;
        pressTimer = setTimeout(()=>{
          const cell=cellFromEl(el); toggleFlag(cell);
        }, 400);
      }, {passive:true});
      el.addEventListener('touchmove', ()=>{ moved=true; if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } });
      el.addEventListener('touchend', (e)=>{
        if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; if(!moved) onClick({ currentTarget: el }); }
      });
      // ダブルクリック風（PC）：数字セルの周囲を開く
      el.addEventListener('dblclick', (e)=>{ const cell=cellFromEl(e.currentTarget); chord(cell); });
    }

    function onClick(e){
      const cell = cellFromEl(e.currentTarget);
      if(cell.open && cell.count>0){ chord(cell); return; }
      openCell(cell);
    }

    function cellFromEl(el){ const r=+el.dataset.r, c=+el.dataset.c; return grid[r][c]; }

    // 初期化
    setDifficulty('easy');
    newGame();
  </script>

  <script>
    function sendHeight() {
      const height = document.documentElement.scrollHeight;
      parent.postMessage({ type: "resize", height: height }, "*");
    }

    const origBuildBoard = buildBoard;
    buildBoard = function() {
      origBuildBoard();
      sendHeight();
    };

    window.addEventListener("resize", sendHeight);
    window.addEventListener("load", sendHeight);
  </script>
  
</body>
</html>
